<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game ƒë∆∞·ª£c t·∫°o b·ªüi Qu·ªëc Ki·ªát</title>
    <style>
        * { user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }
        canvas { display: block; width: 100%; height: 100%; position: absolute; z-index: 1; }

        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; background: #000; }
        #video-bg { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; color: white; text-align: center; padding: 20px; }
        
        .game-title { font-size: 32px; margin-bottom: 30px; color: #f1c40f; text-shadow: 0 0 20px rgba(241, 196, 15, 0.5); font-weight: bold; line-height: 1.4; }
        
        .btn-menu { padding: 15px 35px; font-size: 18px; color: #fff; border: 3px solid #fff; border-radius: 12px; margin: 10px; background: #27ae60; font-weight: bold; cursor: pointer; min-width: 240px; transition: 0.3s; }
        .btn-menu:active { transform: scale(0.95); background: #2ecc71; }

        #hud { position: absolute; top: 15px; left: 15px; width: 250px; display: none; pointer-events: none; }
        .hp-bar { width: 100%; height: 16px; background: rgba(255,255,255,0.2); border-radius: 8px; border: 2px solid #fff; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #2ecc71; }
        .info-text { color: white; font-size: 14px; margin-top: 5px; font-weight: bold; text-shadow: 2px 2px #000; }

        #mini-map { position: absolute; top: 15px; right: 70px; width: 110px; height: 110px; background: rgba(0,0,0,0.8); border: 2px solid #fff; border-radius: 10px; display: none; overflow: hidden; }
        #music-btn { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 50%; display: none; pointer-events: auto; color: white; }

        #joy-zone { position: absolute; bottom: 30px; left: 30px; width: 130px; height: 130px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: none; pointer-events: auto; }
        #joy-stick { width: 55px; height: 55px; background: #fff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        #shoot-ctrl { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; display: none; pointer-events: auto; z-index: 5000; }
        #btn-shoot { width: 100%; height: 100%; background: rgba(231, 76, 60, 0.9); border: 4px solid #fff; border-radius: 50%; color: white; font-weight: bold; font-size: 18px; }

        #rotate-area { position: absolute; top: 0; right: 0; width: 70%; height: 100%; pointer-events: auto; display: none; z-index: 900; }
        #boss-alert { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); color: #ff4757; font-size: 26px; font-weight: bold; text-align: center; display: none; z-index: 2000; text-shadow: 0 0 15px #000; width: 90%; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="video-bg" autoplay loop muted playsinline><source src="vidsanh.mp4" type="video/mp4"></video>
</div>

<div id="ui-layer">
    <div id="m-start" class="overlay">
        <div class="game-title">Game ƒë∆∞·ª£c t·∫°o b·ªüi<br>Qu·ªëc Ki·ªát</div>
        <div class="btn-menu" onclick="showDiff()">V√ÄO TR√í CH∆†I</div>
    </div>

    <div id="m-diff" class="overlay" style="display:none">
        <h2 style="margin-bottom:25px; color:#fff;">CH·ªåN ƒê·ªò KH√ì</h2>
        <div class="btn-menu" style="background:#3498db" onclick="startGame('easy')">D·ªÑ (10 L√≠nh)</div>
        <div class="btn-menu" style="background:#e67e22" onclick="startGame('hard')">KH√ì (20 L√≠nh)</div>
        <div class="btn-menu" style="background:#c0392b" onclick="startGame('extreme')">SI√äU KH√ì (36 L√≠nh - T·ªëc ƒë·ªô gi·∫£m)</div>
    </div>

    <div id="m-end" class="overlay" style="display:none; z-index: 9999;">
        <h1 id="end-status" style="font-size: 35px; color:#f1c40f;"></h1>
        <div class="btn-menu" style="background:#fff; color:#000; margin-top:20px;" onclick="location.reload()">QUAY L·∫†I MENU</div>
    </div>

    <div id="boss-alert">BOSS HAI TRINH XU·∫§T HI·ªÜN!</div>

    <div id="hud">
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div class="info-text">M√ÅU C·ª¶A KI·ªÜT: <span id="hp-val">100</span>%</div>
        <div class="info-text" style="color: #f1c40f;">L√çNH C√íN: <span id="remain-val">0</span></div>
        <div id="boss-hud" style="display:none;">
            <div class="info-text" style="color: #ff4757; font-size: 11px;">BOSS: hai Trinh ƒë·∫πp g√°i nh·∫•t qu·∫£ ƒë·∫•t...</div>
            <div class="info-text" style="color: #ff4757;">M√ÅU BOSS: <span id="boss-hp">0</span></div>
        </div>
    </div>

    <div id="mini-map"><canvas id="mm-canvas" width="110" height="110"></canvas></div>
    <button id="music-btn" onclick="toggleMute()">üîä</button>
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <div id="shoot-ctrl"><button id="btn-shoot">B·∫ÆN</button></div>
    <div id="rotate-area"></div>
</div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
<script type="module">
import * as THREE from 'three';

let scene, camera, renderer, player, clock, active = false;
let playerHp = 100, enemiesLeft = 0, moveDir = {x:0, z:0}, rotY = 0, lastTouchX = 0;
let enemies = [], bullets = [], config = {}, isMuted = false;
let boss = null, bossSummoned = false;

const loader = new THREE.TextureLoader();
const audio = new Audio('nhacnen.mp3'); audio.loop = true;

window.showDiff = () => {
    document.getElementById('m-start').style.display = 'none';
    document.getElementById('m-diff').style.display = 'flex';
};

window.toggleMute = () => {
    isMuted = !isMuted; audio.muted = isMuted;
    document.getElementById('music-btn').innerText = isMuted ? "üîá" : "üîä";
};

window.startGame = (mode) => {
    // ƒê√£ ƒëi·ªÅu ch·ªânh spd c·ªßa extreme xu·ªëng 15 theo y√™u c·∫ßu
    if(mode === 'easy') config = { count: 10, bossHp: 1000, enHp: 100, spd: 12 };
    if(mode === 'hard') config = { count: 20, bossHp: 2000, enHp: 250, spd: 18 };
    if(mode === 'extreme') config = { count: 36, bossHp: 3000, enHp: 500, spd: 15 };

    enemiesLeft = config.count;
    document.getElementById('m-diff').style.display = 'none';
    document.getElementById('video-container').style.display = 'none';
    ['hud','joy-zone','shoot-ctrl','rotate-area','music-btn','mini-map'].forEach(id => document.getElementById(id).style.display = 'block');
    
    audio.play().catch(() => {});
    init();
};

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a20);
    scene.fog = new THREE.FogExp2(0x0a0a20, 0.0008); 

    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 10000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.DirectionalLight(0xffaa66, 2), new THREE.AmbientLight(0xffffff, 0.5));

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(8000, 8000), new THREE.MeshStandardMaterial({ 
        map: loader.load('co.png', (t) => { t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(120, 120); }) 
    }));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    for(let i=0; i<150; i++) {
        const tree = new THREE.Group();
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(12, 16, 160), new THREE.MeshStandardMaterial({color: 0x2d1b00}));
        trunk.position.y = 80; tree.add(trunk);
        const leaves = new THREE.Mesh(new THREE.BoxGeometry(120, 120, 120), new THREE.MeshStandardMaterial({color: 0x0a3d1a}));
        leaves.position.y = 160; tree.add(leaves);
        tree.position.set(Math.random()*6000-3000, 0, Math.random()*6000-3000);
        scene.add(tree);
    }

    player = createRobloxBody('nhanvat.png', 5);
    scene.add(player);

    for(let i=0; i<config.count; i++) spawnEnemy();

    setupControls();
    clock = new THREE.Clock();
    active = true;
    animate();
}

function createRobloxBody(texPath, scale) {
    const group = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({ map: loader.load(texPath) });
    const torso = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2, 0.8), mat);
    torso.position.y = 2.5;
    const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), mat);
    head.position.y = 4.2;
    const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 2, 0.7), mat);
    lLeg.position.set(-0.45, 1, 0); lLeg.name = "lLeg";
    const rLeg = lLeg.clone(); rLeg.position.x = 0.45; rLeg.name = "rLeg";
    const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.6, 2, 0.6), mat);
    lArm.position.set(-1.1, 2.5, 0); lArm.name = "lArm";
    const rArm = lArm.clone(); rArm.position.x = 1.1; rArm.name = "rArm";
    group.add(torso, head, lLeg, rLeg, lArm, rArm);
    group.scale.set(scale, scale, scale);
    return group;
}

function spawnEnemy() {
    const en = createRobloxBody('kedich.png', 5.5);
    en.position.set(Math.random()*4000-2000, 0, Math.random()*4000-2000);
    en.userData = { hp: config.enHp, alive: true };
    enemies.push(en); scene.add(en);
}

function summonBoss() {
    bossSummoned = true;
    boss = createRobloxBody('kedich.png', 16);
    boss.position.set(player.position.x + 300, 0, player.position.z + 300);
    boss.userData = { hp: config.bossHp, isBoss: true, alive: true };
    enemies.push(boss); scene.add(boss);
    document.getElementById('boss-alert').style.display = 'block';
    setTimeout(() => document.getElementById('boss-alert').style.display = 'none', 3000);
    document.getElementById('boss-hud').style.display = 'block';
}

function setupControls() {
    const zone = document.getElementById('joy-zone');
    const stick = document.getElementById('joy-stick');
    const rotateArea = document.getElementById('rotate-area');
    const shootBtn = document.getElementById('btn-shoot');

    zone.addEventListener('pointermove', (e) => {
        const r = zone.getBoundingClientRect();
        const dx = e.clientX - (r.left + r.width/2), dy = e.clientY - (r.top + r.height/2);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 65);
        const a = Math.atan2(dy, dx);
        stick.style.transform = `translate(-50%, -50%) translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
        moveDir = { x: Math.cos(a)*(d/65), z: Math.sin(a)*(d/65) };
    });
    zone.addEventListener('pointerup', () => { moveDir = {x:0, z:0}; stick.style.transform = 'translate(-50%, -50%)'; });

    rotateArea.addEventListener('pointerdown', (e) => { lastTouchX = e.clientX; });
    rotateArea.addEventListener('pointermove', (e) => {
        rotY -= (e.clientX - lastTouchX) * 0.012;
        lastTouchX = e.clientX;
    });

    shootBtn.addEventListener('pointerdown', () => {
        if(!active) return;
        const b = new THREE.Mesh(new THREE.SphereGeometry(5), new THREE.MeshBasicMaterial({color: 0xffea00}));
        b.position.copy(player.position).y += 16;
        const dir = new THREE.Vector3(Math.sin(rotY), 0, Math.cos(rotY)).negate();
        b.userData = { v: dir.multiplyScalar(45), life: 150 };
        bullets.push(b); scene.add(b);
    });
}

function animate() {
    if(!active) return;
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    const time = clock.getElapsedTime();

    if(moveDir.x !== 0 || moveDir.z !== 0) {
        const v = new THREE.Vector3(moveDir.x, 0, moveDir.z).applyAxisAngle(new THREE.Vector3(0,1,0), rotY);
        player.position.add(v.multiplyScalar(dt * 100));
        player.rotation.y = Math.atan2(v.x, v.z);
        player.children.forEach(c => {
            if(c.name.includes("Leg")) c.rotation.x = Math.sin(time*12) * (c.name==="lLeg"?1:-1) * 0.8;
        });
    }

    enemies.forEach(en => {
        if(!en.userData.alive) return;
        const dist = en.position.distanceTo(player.position);
        const spd = en.userData.isBoss ? config.spd * 0.8 : config.spd;
        en.position.add(new THREE.Vector3().subVectors(player.position, en.position).normalize().multiplyScalar(dt * spd * 5.5));
        en.lookAt(player.position.x, 0, player.position.z);
        if(dist < (en.userData.isBoss ? 45 : 28)) playerHp -= (en.userData.isBoss ? 1.5 : 0.8);
    });

    bullets.forEach((b, i) => {
        b.position.add(b.userData.v);
        enemies.forEach(en => {
            if(en.userData.alive && b.position.distanceTo(en.position.clone().add(new THREE.Vector3(0,12,0))) < (en.userData.isBoss ? 45 : 28)) {
                en.userData.hp -= 40; b.userData.life = 0;
                if(en.userData.hp <= 0) { 
                    en.userData.alive = false; scene.remove(en); 
                    if(!en.userData.isBoss) enemiesLeft--; else enemiesLeft = -1;
                }
            }
        });
        if(b.userData.life-- <= 0) { scene.remove(b); bullets.splice(i,1); }
    });

    if(enemiesLeft === 0 && !bossSummoned) summonBoss();

    camera.position.set(player.position.x + Math.sin(rotY)*125, 110, player.position.z + Math.cos(rotY)*125);
    camera.lookAt(player.position.x, player.position.y + 15, player.position.z);

    const mmCtx = document.getElementById('mm-canvas').getContext('2d');
    mmCtx.clearRect(0,0,110,110);
    mmCtx.fillStyle = '#00ffff'; mmCtx.fillRect(53, 53, 5, 5);
    enemies.forEach(en => {
        if(!en.userData.alive) return;
        const dx = (en.position.x - player.position.x)/100 + 55, dz = (en.position.z - player.position.z)/100 + 55;
        mmCtx.fillStyle = en.userData.isBoss ? '#ff00ff' : '#ff0000';
        mmCtx.fillRect(dx-2, dz-2, en.userData.isBoss?8:4, en.userData.isBoss?8:4);
    });

    document.getElementById('hp-fill').style.width = Math.max(0, playerHp) + '%';
    document.getElementById('hp-val').innerText = Math.round(Math.max(0, playerHp));
    document.getElementById('remain-val').innerText = Math.max(0, enemiesLeft);
    if(boss && boss.userData.alive) document.getElementById('boss-hp').innerText = Math.max(0, Math.round(boss.userData.hp));

    renderer.render(scene, camera);
    if(playerHp <= 0 || enemiesLeft === -1) {
        active = false;
        document.getElementById('m-end').style.display = 'flex';
        document.getElementById('end-status').innerText = playerHp <= 0 ? "KI·ªÜT ƒê√É B·ªä H·∫†!" : "QU·ªêC KI·ªÜT CHI·∫æN TH·∫ÆNG!";
    }
}
</script>
</body>
</html>
