<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quốc Kiệt - Survival Boss 3D</title>
    <style>
        * { user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }

        /* Bắt buộc xoay màn hình */
        #rotate-warning { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        @media screen and (orientation: portrait) { #rotate-warning { display: flex; } }

        /* Video nền menu */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; overflow: hidden; }
        #video-bg { width: 100%; height: 100%; object-fit: cover; }

        /* Lớp UI Game */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; z-index: 1100; color: white; }
        
        .btn-menu { padding: 16px 50px; font-size: 22px; color: #fff; border: 3px solid #fff; border-radius: 50px; margin: 15px; background: #27ae60; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* HUD Máu & Boss */
        #hud { position: absolute; top: 15px; left: 15px; width: 220px; display: none; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 12px; border: 1.5px solid #fff; }
        .hp-bar-container { width: 100%; height: 14px; background: #333; border-radius: 7px; overflow: hidden; border: 1px solid #666; }
        #hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.2s; }
        
        #boss-ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 350px; display: none; text-align: center; z-index: 1001; }
        #boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4b2b, #ff416c); transition: width 0.1s; }

        /* Joystick & Nút Bắn sát rìa */
        #joy-zone { position: absolute; bottom: 35px; left: 35px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: none; pointer-events: auto; }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 65px; height: 65px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        #shoot-ctrl { position: absolute; bottom: 35px; right: 35px; display: none; pointer-events: auto; }
        #btn-shoot { width: 95px; height: 95px; background: radial-gradient(circle, #e74c3c, #c0392b); border: 4px solid #fff; border-radius: 50%; color: white; font-weight: bold; font-size: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

<div id="rotate-warning">
    <img src="https://cdn-icons-png.flaticon.com/512/575/575454.png" width="80" style="filter: invert(1); margin-bottom: 15px;">
    <h2>VUI LÒNG XOAY NGANG MÀN HÌNH</h2>
</div>

<div id="video-container">
    <video id="video-bg" autoplay loop muted playsinline><source src="vidsanh.mp4" type="video/mp4"></video>
</div>

<div id="ui-layer">
    <div id="m-start" class="overlay">
        <h1 style="font-size: 48px; text-shadow: 3px 3px 10px #000;">QUỐC KIỆT: BOSS FIGHT</h1>
        <div class="btn-menu" onclick="startGame()">VÀO TRẬN</div>
    </div>

    <div id="m-end" class="overlay" style="display:none">
        <h1 id="end-status" style="font-size: 50px; margin-bottom: 25px; text-shadow: 2px 2px #000;"></h1>
        <div class="btn-menu" onclick="location.reload()">CHƠI LẠI</div>
    </div>

    <div id="hud">
        <div class="hp-bar-container"><div id="hp-fill"></div></div>
        <div style="color:white; font-size: 13px; margin-top:6px; display:flex; justify-content: space-between; font-weight:bold;">
            <span>MÁU: <span id="hp-val">100</span></span>
            <span>DIỆT: <span id="killed-val">0</span></span>
        </div>
    </div>

    <div id="boss-ui">
        <div style="color:#ff4b2b; font-weight:bold; font-size: 18px; text-shadow: 2px 2px #000; margin-bottom: 5px;">BOSS KHỔNG LỒ</div>
        <div class="hp-bar-container" style="height:18px; border:2px solid #fff;"><div id="boss-hp-fill"></div></div>
    </div>
    
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <div id="shoot-ctrl"><button id="btn-shoot">BẮN</button></div>
</div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
<script type="module">
import * as THREE from 'three';

let scene, camera, renderer, player, boss, clock, active = false;
let playerHp = 100, killed = 0, enemyCount = 10, isBossStage = false;
let enemies = [], bullets = [], trees = [], moveDir = {x:0, z:0}, rotY = 0;
const loader = new THREE.TextureLoader();
const bgMusic = new Audio('nhacnen.mp3'); bgMusic.loop = true;

window.startGame = () => {
    bgMusic.play().catch(()=>{});
    document.getElementById('m-start').style.display = 'none';
    document.getElementById('video-container').style.display = 'none';
    ['hud','joy-zone','shoot-ctrl'].forEach(id => document.getElementById(id).style.display = 'block');
    init();
};

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    scene.fog = new THREE.Fog(0x87CEEB, 20, 160);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true; // Bật đồ bóng nắng
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    // Ánh sáng mặt trời tạo bóng đổ
    const sun = new THREE.DirectionalLight(0xffffff, 1.5);
    sun.position.set(30, 60, 30);
    sun.castShadow = true;
    sun.shadow.mapSize.width = 1024;
    sun.shadow.mapSize.height = 1024;
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));

    // Mặt đất dùng co.png
    const groundMat = new THREE.MeshStandardMaterial({map: loader.load('co.png', (t)=>{t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(50,50)})});
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), groundMat);
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true;
    scene.add(ground);

    // Cây nhiều tán lá (Yêu cầu của bạn)
    for(let i=0; i<45; i++) {
        const tree = new THREE.Group();
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.7, 5), new THREE.MeshStandardMaterial({color: 0x4d2600}));
        trunk.position.y = 2.5; trunk.castShadow = true; trunk.receiveShadow = true;
        tree.add(trunk);
        
        // 3 tầng lá tròn
        for(let j=0; j<3; j++) {
            const leaf = new THREE.Mesh(new THREE.SphereGeometry(3 - j*0.6, 8, 8), new THREE.MeshStandardMaterial({color: 0x2ecc71}));
            leaf.position.y = 5 + j*1.8; leaf.castShadow = true;
            tree.add(leaf);
        }
        tree.position.set(Math.random()*300-150, 0, Math.random()*300-150);
        scene.add(tree); trees.push(new THREE.Box3().setFromObject(tree));
    }

    // Nhân vật chính 3D dùng nhanvat.png
    player = create3DChar('nhanvat.png', 1);
    scene.add(player);

    for(let i=0; i<enemyCount; i++) spawnEnemy();

    setupControls();
    active = true;
    clock = new THREE.Clock();
    animate();
}

function create3DChar(texPath, scale) {
    const group = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({map: loader.load(texPath)});
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.2*scale, 1.8*scale, 0.8*scale), mat);
    body.position.y = 0.9*scale; body.castShadow = true;
    
    const head = new THREE.Mesh(new THREE.BoxGeometry(scale, scale, scale), mat);
    head.position.y = 2.3*scale; head.castShadow = true;

    group.add(body, head);
    return group;
}

function spawnEnemy() {
    const en = create3DChar('kedich.png', 1);
    en.position.set(Math.random()*200-100, 0, Math.random()*200-100);
    en.userData = { hp: 20, alive: true };
    enemies.push(en); scene.add(en);
}

function spawnBoss() {
    isBossStage = true;
    document.getElementById('boss-ui').style.display = 'block';
    boss = create3DChar('kedich.png', 5); // Boss cực to
    boss.position.set(0, 0, -60);
    boss.userData = { hp: 500, alive: true, isBoss: true };
    enemies.push(boss); scene.add(boss);
}

function setupControls() {
    const zone = document.getElementById('joy-zone');
    const stick = document.getElementById('joy-stick');
    zone.addEventListener('pointermove', (e) => {
        const r = zone.getBoundingClientRect();
        let dx = e.clientX - (r.left + 70), dy = e.clientY - (r.top + 70);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
        const a = Math.atan2(dy, dx);
        stick.style.left = `calc(50% + ${Math.cos(a)*d}px)`;
        stick.style.top = `calc(50% + ${Math.sin(a)*d}px)`;
        moveDir = {x: Math.cos(a)*(d/50), z: Math.sin(a)*(d/50)};
    });
    zone.addEventListener('pointerup', () => { moveDir={x:0, z:0}; stick.style.left='50%'; stick.style.top='50%'; });
    
    document.getElementById('btn-shoot').addEventListener('pointerdown', (e) => {
        e.preventDefault();
        const b = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0xffff00}));
        b.position.copy(player.position).y += 1.5;
        const dir = new THREE.Vector3(Math.sin(rotY), 0, Math.cos(rotY)).negate();
        b.userData = { v: dir.multiplyScalar(4), life: 100 };
        bullets.push(b); scene.add(b);
    });
}

function animate() {
    if(!active) return;
    requestAnimationFrame(animate);
    const dt = clock.getDelta();

    if(moveDir.x !== 0 || moveDir.z !== 0) {
        const v = new THREE.Vector3(moveDir.x, 0, moveDir.z).applyAxisAngle(new THREE.Vector3(0,1,0), rotY);
        player.position.add(v.multiplyScalar(dt * 24));
        player.rotation.y = Math.atan2(v.x, v.z);
    }

    bullets.forEach((b, i) => {
        b.position.add(b.userData.v);
        enemies.forEach(en => {
            if(en.userData.alive && b.position.distanceTo(en.position.clone().setY(2* (en.userData.isBoss?3:1))) < (en.userData.isBoss ? 6 : 2.5)) {
                en.userData.hp -= 10; b.userData.life = 0;
                if(en.userData.isBoss) document.getElementById('boss-hp-fill').style.width = (en.userData.hp/5) + '%';
                if(en.userData.hp <= 0) {
                    en.userData.alive = false; scene.remove(en);
                    if(en.userData.isBoss) endGame("CHIẾN THẮNG!");
                    else { killed++; document.getElementById('killed-val').innerText = killed; }
                }
            }
        });
        if(b.userData.life-- <= 0) { scene.remove(b); bullets.splice(i,1); }
    });

    if(killed >= enemyCount && !isBossStage) spawnBoss();

    enemies.forEach(en => {
        if(!en.userData.alive) return;
        const d = new THREE.Vector3().subVectors(player.position, en.position).normalize();
        en.position.add(d.multiplyScalar(dt * (en.userData.isBoss ? 4.5 : 6.5)));
        en.rotation.y = Math.atan2(d.x, d.z);
        if(en.position.distanceTo(player.position) < (en.userData.isBoss ? 6.5 : 2.2)) playerHp -= 0.25;
    });

    camera.position.set(player.position.x + Math.sin(rotY)*25, 15, player.position.z + Math.cos(rotY)*25);
    camera.lookAt(player.position);
    
    document.getElementById('hp-fill').style.width = playerHp + '%';
    document.getElementById('hp-val').innerText = Math.max(0, Math.ceil(playerHp));
    
    renderer.render(scene, camera);
    if(playerHp <= 0) endGame("THẤT BẠI!");
}

function endGame(status) {
    active = false;
    document.getElementById('m-end').style.display = 'flex';
    document.getElementById('end-status').innerText = status;
    document.getElementById('end-status').style.color = (status === "CHIẾN THẮNG!") ? "#2ecc71" : "#ff4b2b";
}

window.addEventListener('pointermove', (e) => { if(active && e.clientX > window.innerWidth/2) rotY -= e.movementX * 0.007; });
window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
</script>
</body>
</html>
