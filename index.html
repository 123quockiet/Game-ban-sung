<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Game Quốc Kiệt - Hoàn Chỉnh</title>
    <style>
        * { user-select: none; -webkit-tap-highlight-color: transparent; touch-action: none; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; position: fixed; font-family: sans-serif; }
        
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #video-bg { width: 100%; height: 100%; object-fit: cover; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }

        /* Các lớp Menu (Start / End) */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                   background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
                   align-items: center; justify-content: center; pointer-events: auto; z-index: 1100; text-align: center; }
        
        .btn-menu { padding: 12px 40px; font-size: 20px; color: #fff; border: 2px solid #fff; 
                    border-radius: 30px; margin: 10px; background: #2ecc71; font-weight: bold; cursor: pointer; text-transform: uppercase; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .btn-menu:active { transform: scale(0.95); }

        /* HUD Máu - Góc trên trái */
        #hud { position: absolute; top: 10px; left: 10px; width: 220px; display: none; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px; border: 1px solid #fff; pointer-events: auto; }
        .hp-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #00ff00; transition: width 0.2s; }
        .stats { color: white; font-size: 11px; margin-top: 5px; font-weight: bold; display: flex; justify-content: space-between; }

        /* Nút Âm Thanh - Dưới HUD */
        #audio-ctrl { position: absolute; top: 60px; left: 10px; width: 40px; height: 40px; 
                      background: rgba(0,0,0,0.6); border: 1.5px solid #fff; border-radius: 50%; 
                      display: none; align-items: center; justify-content: center; pointer-events: auto; cursor: pointer; }
        #audio-icon { width: 20px; height: 20px; filter: invert(1); }

        /* Bản đồ - Góc trên phải */
        #minimap-container { position: absolute; top: 10px; right: 10px; width: 100px; height: 100px; border-radius: 50%; border: 2px solid #fff; display: none; background: rgba(0,20,0,0.8); overflow: hidden; pointer-events: auto; }

        /* Joystick - Góc dưới trái */
        #joy-zone { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: none; pointer-events: auto; }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        /* Nút Bắn - Góc dưới phải (Nhỏ gọn) */
        #shoot-ctrl { position: absolute; bottom: 35px; right: 35px; display: none; pointer-events: auto; }
        #btn-shoot { width: 90px; height: 90px; background: rgba(220, 20, 60, 0.85); border: 3px solid #fff; border-radius: 50%; color: white; font-weight: bold; font-size: 18px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #btn-shoot:active { background: rgba(255, 0, 0, 1); transform: scale(0.95); }
    </style>
</head>
<body>

<div id="video-container">
    <video id="video-bg" autoplay loop muted playsinline><source src="vidsanh.mp4" type="video/mp4"></video>
</div>

<div id="ui-layer">
    <div id="m1" class="overlay">
        <h3 style="color:#2ecc71;">Game được tạo bởi</h3>
        <h1 style="color:white; font-size: 40px; margin-bottom: 20px;">Quốc Kiệt</h1>
        <div class="btn-menu" onclick="document.getElementById('m1').style.display='none'; document.getElementById('m2').style.display='flex';">BẮT ĐẦU</div>
    </div>

    <div id="m2" class="overlay" style="display:none">
        <h2 style="color:white; margin-bottom: 20px;">CHỌN ĐỘ KHÓ</h2>
        <div class="btn-menu" style="background:#3498db" onclick="startGame(10, 15)">DỄ (10 ĐỊCH)</div>
        <div class="btn-menu" style="background:#e67e22" onclick="startGame(30, 45)">KHÓ (30 ĐỊCH)</div>
        <div class="btn-menu" style="background:#e74c3c" onclick="startGame(45, 120)">SIÊU KHÓ (45 ĐỊCH)</div>
    </div>

    <div id="m3" class="overlay" style="display:none">
        <h1 id="end-title" style="color:white; font-size: 45px; margin-bottom: 20px;"></h1>
        <div class="btn-menu" onclick="location.reload()">CHƠI LẠI</div>
    </div>

    <div id="hud">
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div class="stats">
            <span>HP: <span id="hp-val">100</span></span>
            <span style="color:#ff4444">CÒN: <span id="remain">0</span></span>
        </div>
    </div>
    
    <div id="audio-ctrl">
        <img id="audio-icon" src="https://cdn-icons-png.flaticon.com/512/727/727269.png">
    </div>

    <div id="minimap-container"><canvas id="m-canvas" width="100" height="100"></canvas></div>
    <div id="joy-zone"><div id="joy-stick"></div></div>
    <div id="shoot-ctrl"><button id="btn-shoot">BẮN</button></div>
</div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
<script type="module">
import * as THREE from 'three';

let scene, camera, renderer, player, clock, active = false;
let playerHp = 100, killed = 0, enemyCount = 0, maxEnemyHp = 15;
let enemies = [], bullets = [], trees = [], moveDir = {x:0, z:0}, rotY = 0;
const bgMusic = new Audio('nhacnen.mp3'); bgMusic.loop = true;

// Xử lý nút âm thanh
document.getElementById('audio-ctrl').onclick = () => {
    bgMusic.muted = !bgMusic.muted;
    document.getElementById('audio-icon').style.opacity = bgMusic.muted ? "0.4" : "1";
};

window.startGame = (count, hp) => {
    enemyCount = count; maxEnemyHp = hp;
    bgMusic.play().catch(()=>{});
    document.getElementById('m2').style.display = 'none';
    document.getElementById('video-container').style.display = 'none';
    
    // Hiển thị các nút điều khiển
    ['hud','minimap-container','joy-zone','shoot-ctrl','audio-ctrl'].forEach(id => document.getElementById(id).style.display = 'flex');
    document.getElementById('hud').style.display = 'block'; // Fix display type
    
    init();
};

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const loader = new THREE.TextureLoader();
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), new THREE.MeshStandardMaterial({map: loader.load('co.png', (t)=>{t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(50,50)})}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);
    scene.add(new THREE.AmbientLight(0xffffff, 1.2));

    // Tạo Cây
    for(let i=0; i<35; i++) {
        const tree = new THREE.Group();
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1, 7), new THREE.MeshStandardMaterial({color: 0x5D4037}));
        const leaves = new THREE.Mesh(new THREE.SphereGeometry(4, 7, 7), new THREE.MeshStandardMaterial({color: 0x2ecc71}));
        trunk.position.y = 3.5; leaves.position.y = 9;
        tree.add(trunk, leaves);
        tree.position.set(Math.random()*280-140, 0, Math.random()*280-140);
        scene.add(tree); trees.push(new THREE.Box3().setFromObject(tree));
    }

    player = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), Array(6).fill(new THREE.MeshStandardMaterial({map: loader.load('nhanvat.png')})));
    player.position.y = 1; scene.add(player);

    for(let i=0; i<enemyCount; i++) {
        const en = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), Array(6).fill(new THREE.MeshStandardMaterial({map: loader.load('kedich.png')})));
        en.position.set(Math.random()*300-150, 1, Math.random()*300-150);
        en.userData = { hp: maxEnemyHp, alive: true };
        enemies.push(en); scene.add(en);
    }

    setupControls();
    active = true;
    clock = new THREE.Clock();
    animate();
}

function setupControls() {
    const zone = document.getElementById('joy-zone');
    const stick = document.getElementById('joy-stick');
    const shootBtn = document.getElementById('btn-shoot');

    zone.addEventListener('pointerdown', (e) => zone.setPointerCapture(e.pointerId));
    zone.addEventListener('pointermove', (e) => {
        if(!zone.hasPointerCapture(e.pointerId)) return;
        const r = zone.getBoundingClientRect();
        let dx = e.clientX - (r.left + r.width/2), dy = e.clientY - (r.top + r.height/2);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 55);
        const a = Math.atan2(dy, dx);
        stick.style.left = `calc(50% + ${Math.cos(a)*d}px)`;
        stick.style.top = `calc(50% + ${Math.sin(a)*d}px)`;
        moveDir = {x: Math.cos(a)*(d/55), z: Math.sin(a)*(d/55)};
    });
    zone.addEventListener('pointerup', () => { stick.style.left='50%'; stick.style.top='50%'; moveDir={x:0, z:0}; });

    shootBtn.addEventListener('pointerdown', (e) => {
        e.preventDefault(); e.stopPropagation();
        const b = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({color: 0xff0000}));
        b.position.copy(player.position);
        const dir = new THREE.Vector3(Math.sin(rotY), 0, Math.cos(rotY)).negate();
        b.userData = { v: dir.multiplyScalar(4.5), life: 100 };
        bullets.push(b); scene.add(b);
    }, {passive: false});

    let lx = 0;
    window.addEventListener('pointerdown', (e) => { if(e.clientX > window.innerWidth/2) lx = e.clientX; });
    window.addEventListener('pointermove', (e) => {
        if(active && e.clientX > window.innerWidth/2) { rotY -= (e.clientX - lx)*0.008; lx = e.clientX; }
    });
}

function endGame(win) {
    active = false;
    document.getElementById('m3').style.display = 'flex';
    const title = document.getElementById('end-title');
    if(win) {
        title.innerText = "CHIẾN THẮNG!";
        title.style.color = "#2ecc71";
    } else {
        title.innerText = "THẤT BẠI!";
        title.style.color = "#ff4444";
    }
}

function animate() {
    if(!active) return;
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    const oldPos = player.position.clone();

    if(moveDir.x !== 0 || moveDir.z !== 0) {
        const v = new THREE.Vector3(moveDir.x, 0, moveDir.z).applyAxisAngle(new THREE.Vector3(0,1,0), rotY);
        player.position.add(v.multiplyScalar(dt * 23));
    }
    const pBox = new THREE.Box3().setFromObject(player);
    trees.forEach(tBox => { if(pBox.intersectsBox(tBox)) player.position.copy(oldPos); });

    bullets.forEach((b, i) => {
        b.position.add(b.userData.v); b.userData.life--;
        enemies.forEach(en => {
            if(en.userData.alive && b.position.distanceTo(en.position) < 2.5) {
                en.userData.hp -= 10; b.userData.life = 0;
                if(en.userData.hp <= 0) { 
                    en.userData.alive = false; scene.remove(en); killed++; 
                    if(killed >= enemyCount) endGame(true);
                }
            }
        });
        if(b.userData.life <= 0) { scene.remove(b); bullets.splice(i,1); }
    });

    enemies.forEach(en => {
        if(!en.userData.alive) return;
        const d = new THREE.Vector3().subVectors(player.position, en.position).normalize();
        en.position.add(d.multiplyScalar(dt * 5.2));
        if(en.position.distanceTo(player.position) < 2) playerHp -= 0.15;
    });

    camera.position.set(player.position.x + Math.sin(rotY)*25, 18, player.position.z + Math.cos(rotY)*25);
    camera.lookAt(player.position);

    document.getElementById('hp-fill').style.width = Math.max(0, playerHp) + '%';
    document.getElementById('hp-val').innerText = Math.ceil(playerHp);
    document.getElementById('remain').innerText = Math.max(0, enemyCount - killed);
    
    drawMinimap();
    renderer.render(scene, camera);
    
    if(playerHp <= 0) endGame(false);
}

function drawMinimap() {
    const ctx = document.getElementById('m-canvas').getContext('2d');
    ctx.clearRect(0,0,100,100);
    const s = 100/400;
    ctx.fillStyle = "red"; enemies.forEach(e => { if(e.userData.alive) ctx.fillRect(50+e.position.x*s, 50+e.position.z*s, 3, 3); });
    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(50+player.position.x*s, 50+player.position.z*s, 4, 0, Math.PI*2); ctx.fill();
}
</script>
</body>
</html>
